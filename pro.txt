import { Composer, Markup } from 'telegraf';
import type { CustomContext } from '../middlewares/userAuth';
import { escapeMarkdownV2 } from '../utils/escape';
import { prisma } from '../prisma';
import config from '../config/config.json';
import { changeCapital } from './economy';

const admins: number[] = config.manage.buildings.admins;
const building = new Composer<CustomContext>();

// Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø²
building.action('building', async (ctx) => {
    const keyboard = Markup.inlineKeyboard([
        [Markup.button.callback('ğŸš— Ø®ÙˆØ¯Ø±ÙˆØ³Ø§Ø²ÛŒ', 'build_car')],
        [Markup.button.callback('ğŸ¬ ÙÛŒÙ„Ù…â€ŒØ³Ø§Ø²ÛŒ', 'build_film')],
        [Markup.button.callback('ğŸµ Ù…ÙˆØ²ÛŒÚ©â€ŒØ³Ø§Ø²ÛŒ', 'build_music')],
        [Markup.button.callback('ğŸ® Ø¨Ø§Ø²ÛŒâ€ŒØ³Ø§Ø²ÛŒ', 'build_game')],
        [Markup.button.callback('ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'back_main'), Markup.button.callback('âŒ Ø¨Ø³ØªÙ†', 'delete')]
    ]);
    await ctx.reply('ğŸ— Ù†ÙˆØ¹ Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:', keyboard);
    ctx.answerCbQuery();
});

// Ø´Ø±ÙˆØ¹ Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡
for (const type of ['car', 'film', 'music', 'game']) {
    building.action(`build_${type}`, async (ctx) => {
        ctx.session = {
            buildingType: type
        };

        if (type === 'car') {
            ctx.session.setupCost = 250_000_000;
            ctx.session.buildingStep = 'awaiting_name';
            await ctx.reply('ğŸ“Œ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯Ø±Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
        } else {
            ctx.session.buildingStep = 'awaiting_setup_cost';
            await ctx.reply('ğŸ’° Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ø¨ÛŒÙ† 55 ØªØ§ 750 Ù…ÛŒÙ„ÛŒÙˆÙ†):');
        }

        ctx.answerCbQuery();
    });
}


// Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡
building.on('text', async (ctx, next) => {
    ctx.session ??= {};

    if (ctx.session.buildingStep === 'awaiting_setup_cost') {
        const raw = ctx.message.text?.trim();
        const cost = Number(raw.replace(/[^\d]/g, ''));
        if (isNaN(cost) || cost < 55_000_000 || cost > 750_000_000) {
            return ctx.reply('âŒ Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ÛŒ Ø¨ÛŒÙ† 55 ØªØ§ 750 Ù…ÛŒÙ„ÛŒÙˆÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†.');
        }

        const userId = BigInt(ctx.from.id);
        const user = await prisma.user.findUnique({ where: { userid: userId } });
        if (!user) return ctx.reply('âŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');

        if (user.capital < BigInt(cost)) {
            return ctx.reply(
                `âŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!\n` +
                `ğŸ’° Ø³Ø±Ù…Ø§ÛŒÙ‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${(cost / 1_000_000).toLocaleString()}M\n` +
                `ğŸ’³ Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§: ${Number(user.capital / BigInt(1_000_000)).toLocaleString()}M`
            );
        }

        ctx.session.setupCost = cost;
        ctx.session.buildingStep = 'awaiting_name';
        await ctx.reply('ğŸ“Œ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
        return;
    }

    if (ctx.session.buildingStep === 'awaiting_name') {
        const name = ctx.message.text?.trim();
        if (!name || name.length < 2) return ctx.reply('âŒ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');

        ctx.session.buildingName = name;
        ctx.session.buildingStep = 'awaiting_image';
        await ctx.reply('ğŸ–¼ Ø­Ø§Ù„Ø§ ØªØµÙˆÛŒØ± Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†:');
        return;
    }

    if (ctx.session.buildingStep === 'awaiting_build_description') {
        const description = ctx.message.text?.trim();
        if (!description || description.length < 5) return ctx.reply('âŒ ØªÙˆØ¶ÛŒØ­ Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡Ù‡.');

        ctx.session.buildingDescription = description;
        ctx.session.buildingStep = 'awaiting_admin_review';

        const preview = escapeMarkdownV2(
            `ğŸ­ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø³Ø§Ø®Øª ${ctx.session.buildingType === 'car' ? 'Ø®ÙˆØ¯Ø±Ùˆ' : `Ù¾Ø±ÙˆÚ˜Ù‡ ${ctx.session.buildingType}`}\n\n` +
            `> Ú©Ø´ÙˆØ± Ø³Ø§Ø²Ù†Ø¯Ù‡: *${ctx.user?.countryName}*\n` +
            `> Ù…Ø­ØµÙˆÙ„: *${ctx.session.buildingName}*\n` +
            `> ØªÙˆØ¶ÛŒØ­: ${ctx.session.buildingDescription}\n\n` +
            `Ø¨ÙˆØ¯Ø¬Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: ${Math.floor(ctx.session.setupCost / 1_000_000)}M\n` +
            (ctx.session.buildingType === 'car' ? 'Ø¸Ø±ÙÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: 15 Ø®ÙˆØ¯Ø±Ùˆ\n\n' : '') +
            `âœ… Ø§Ú¯Ø± ØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù† ØªØ§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯.`
        );

        const keyboard = Markup.inlineKeyboard([
            [Markup.button.callback('âœ… Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ†', 'submit_building')],
            [Markup.button.callback('ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'building')]
        ]);

        await ctx.replyWithPhoto(ctx.session.buildingImageFileId, {
            caption: preview,
            parse_mode: 'MarkdownV2',
            reply_markup: keyboard.reply_markup
        });
        return;
    }

    return next();
});

// Ø¯Ø±ÛŒØ§ÙØª ØªØµÙˆÛŒØ±
building.on('photo', async (ctx, next) => {
    ctx.session ??= {};
    if (ctx.session.buildingStep !== 'awaiting_image') return next();

    const photo = ctx.message.photo?.at(-1);
    if (!photo) return ctx.reply('âŒ ØªØµÙˆÛŒØ± Ù…Ø¹ØªØ¨Ø± Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡.');

    const imageUrl = await ctx.telegram.getFileLink(photo.file_id);
    ctx.session.buildingImage = imageUrl.href;
    ctx.session.buildingImageFileId = photo.file_id;
    ctx.session.buildingStep = 'awaiting_build_description';

    await ctx.reply('ğŸ“ ØªÙˆØ¶ÛŒØ­ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø­ØµÙˆÙ„Øª Ø¨Ù†ÙˆÛŒØ³ (Ù…Ø«Ù„Ø§Ù‹ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ ÛŒØ§ Ù‡Ø¯Ù ØªÙˆÙ„ÛŒØ¯):');
});

// Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
building.action('submit_building', async (ctx) => {
    ctx.session ??= {};
    const { buildingType, buildingName, buildingImageFileId, buildingDescription, setupCost } = ctx.session;
    const userId = BigInt(ctx.from.id);
    const country = ctx.user?.countryName;

    if (!buildingType || !buildingName || !buildingImageFileId || !buildingDescription || !country) {
        return ctx.reply('âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª.');
    }

    const imageUrl = await ctx.telegram.getFileLink(buildingImageFileId).then(link => link.href);
    const result = await changeCapital(userId, 'subtract', setupCost);
    if (result !== 'ok') return ctx.reply('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ø³Ø± Ø³Ø±Ù…Ø§ÛŒÙ‡.');

    const profitPercent = buildingType === 'car' ? null : Math.floor(10 + Math.random() * 72);

    await prisma.pendingProductionLine.create({
        data: {
            ownerId: userId,
            name: buildingName,
            type: buildingType,
            imageUrl,
            imageFileId: buildingImageFileId,
            description: buildingDescription,
            dailyLimit: 15,
            setupCost: BigInt(setupCost),
            country,
            profitPercent
        }
    });

    const caption = escapeMarkdownV2(
        `ğŸ“¥ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª ${buildingType === 'car' ? 'Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ø±Ùˆ' : `Ù¾Ø±ÙˆÚ˜Ù‡ ${buildingType}`}\n\n` +
        `> Ú©Ø´ÙˆØ±: *${country}*\n` +
        `> Ù†Ø§Ù…: *${buildingName}*\n` +
        `> ØªÙˆØ¶ÛŒØ­: ${buildingDescription}\n` +
        `> Ø¨ÙˆØ¯Ø¬Ù‡: ${Math.floor(setupCost / 1_000_000)}M` +
        (profitPercent !== null ? `\n> Ø³ÙˆØ¯Ø¯Ù‡ÛŒ: ${profitPercent}%` : '') +
        (buildingType === 'car' ? `\nØ¸Ø±ÙÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: 15 Ø®ÙˆØ¯Ø±Ùˆ` : '')
    );

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.callback('âœ… ØªØ£ÛŒÛŒØ¯ Ø³Ø§Ø®Øª', `admin_approve_building_${userId}`)],
        [Markup.button.callback('âŒ Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª', `admin_reject_building_${userId}`)]
    ]);

    for (const admin of admins) {
        await ctx.telegram.sendPhoto(admin, buildingImageFileId, {
            caption,
            parse_mode: 'MarkdownV2',
            reply_markup: keyboard.reply_markup
        });
    }

    await ctx.reply('ğŸ“¤ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
    ctx.session.buildingStep = undefined;
});

// ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
building.action(/admin_approve_building_(\d+)/, async (ctx) => {
    const userId = BigInt(ctx.match[1]);
    const user = await prisma.user.findUnique({where: {userid: userId}});
    const pending = await prisma.pendingProductionLine.findFirst({where: {ownerId: userId}});
    if (!user || !pending) return ctx.reply('âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.');

    await prisma.productionLine.create({
        data: {
            ownerId: userId,
            name: pending.name,
            type: pending.type,
            imageUrl: pending.imageUrl,
            imageFileId: ctx.session.buildingImageFileId,
            dailyLimit: pending.dailyLimit,
            setupCost: pending.setupCost,
            country: pending.country,
            profitPercent: pending.profitPercent
        }
    });

    await prisma.pendingProductionLine.delete({where: {id: pending.id}});

    await ctx.telegram.sendPhoto(config.channels.updates, pending.imageFileId, {
        caption: escapeMarkdownV2(
            `ğŸ­ Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯\n\n` +
            `> Ú©Ø´ÙˆØ± Ø³Ø§Ø²Ù†Ø¯Ù‡: *${user.countryName}*\n` +
            `> Ù…Ø­ØµÙˆÙ„: *${pending.name}*\n\n` +
            `Ø¨ÙˆØ¯Ø¬Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: ${pending.setupCost.toLocaleString()} Ø±ÛŒØ§Ù„\n` +
            `Ø¸Ø±ÙÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: ${pending.dailyLimit} ÙˆØ§Ø­Ø¯`
        ),
        parse_mode: 'MarkdownV2'
    });

    await ctx.reply('âœ… Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
});

// Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†
building.action(/admin_reject_building_(\d+)/, async (ctx) => {
    const userId = BigInt(ctx.match[1]);
    const adminId = ctx.from.id;

    if (!admins.includes(adminId)) {
        return ctx.answerCbQuery('â›” ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ø±Ø¯ Ú©Ù†Ù‡.');
    }

    const pending = await prisma.pendingProductionLine.findFirst({ where: { ownerId: userId } });

    if (!pending) {
        return ctx.answerCbQuery('âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    }

    // Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾ÙˆÙ„
    const result = await changeCapital(userId, 'add', Number(pending.setupCost));
    if (result === 'not_found') {
        return ctx.answerCbQuery('âŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    }
    if (result === 'invalid' || result === 'error') {
        return ctx.answerCbQuery('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾ÙˆÙ„.');
    }

    // Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    await prisma.pendingProductionLine.deleteMany({ where: { ownerId: userId } });

    // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    try {
        await ctx.telegram.sendMessage(Number(userId),
            `âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³Ø§Ø®Øª Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯.\nğŸ’° Ù…Ø¨Ù„Øº ${Number(pending.setupCost / BigInt(1_000_000)).toLocaleString()}M Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø±Ú¯Ø´Øª.`
        );
    } catch (err) {
        console.warn('Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ PV Ú©Ø§Ø±Ø¨Ø± Ù…Ù…Ú©Ù† Ù†Ø¨ÙˆØ¯:', err);
    }

    await ctx.answerCbQuery('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø¯ Ø´Ø¯ Ùˆ Ù¾ÙˆÙ„ Ø¨Ø±Ú¯Ø´Øª.');
});



export default building;
in building hast

va in ham market :
import { Composer, Markup } from 'telegraf';
import type { CustomContext } from '../middlewares/userAuth';
import { prisma } from '../prisma';
import { changeCapital } from './economy';
import { escapeMarkdownV2 } from '../utils/escape';

const sell = new Composer<CustomContext>();

// ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´
function calculateSellPrice(prod: {
    type: string;
    unitPrice?: number | null;
    dailyLimit: number;
    setupCost: bigint;
    profitPercent?: number | null;
}): number {
    if (prod.type === 'car') {
        return (prod.unitPrice ?? 0) * prod.dailyLimit;
    }
    const base = Number(prod.setupCost);
    const profit = Math.floor(base * (prod.profitPercent ?? 0) / 100);
    return base + profit;
}

// Ù†Ù…Ø§ÛŒØ´ ØªÙˆÙ„ÛŒØ¯Ø§Øª Ù‚Ø§Ø¨Ù„ ÙØ±ÙˆØ´
sell.action('sell', async (ctx) => {
    const userId = BigInt(ctx.from.id);
    const productions = await prisma.productionLine.findMany({ where: { ownerId: userId } });

    if (productions.length === 0) {
        await ctx.reply('âŒ Ø´Ù…Ø§ Ù‡ÛŒÚ† ØªÙˆÙ„ÛŒØ¯ ÙØ¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ù†Ø¯Ø§Ø±ÛŒØ¯.');
        return ctx.answerCbQuery();
    }

    for (const prod of productions) {
        const price = calculateSellPrice(prod);
        const caption = escapeMarkdownV2(
            `ğŸ›’ ${prod.name} (${prod.type})\n` +
            `ğŸ’° Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´: ${Math.floor(price / 1_000_000)}M`
        );

        const keyboard = Markup.inlineKeyboard([
            [Markup.button.callback(`ğŸ“¤ ÙØ±ÙˆØ´ Ø¨Ù‡ ${Math.floor(price / 1_000_000)}M`, `sell_${prod.id}`)]
        ]);

        try {
            if (prod.imageFileId) {
                await ctx.replyWithPhoto(prod.imageFileId, {
                    caption,
                    parse_mode: 'MarkdownV2',
                    reply_markup: keyboard.reply_markup
                });
            } else {
                await ctx.reply(caption, {
                    parse_mode: 'MarkdownV2',
                    reply_markup: keyboard.reply_markup
                });
            }
        } catch (err) {
            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³:', err);
            await ctx.reply(caption, {
                parse_mode: 'MarkdownV2',
                reply_markup: keyboard.reply_markup
            });
        }
    }

    await ctx.answerCbQuery();
});

// Ù‡Ù†Ø¯Ù„ ÙØ±ÙˆØ´ Ø¨Ø§ Ø¯Ú©Ù…Ù‡
sell.action(/^sell_(\d+)$/, async (ctx) => {
    const prodId = Number(ctx.match[1]);
    const userId = BigInt(ctx.from.id);

    const prod = await prisma.productionLine.findUnique({ where: { id: prodId } });
    if (!prod || prod.ownerId !== userId) {
        return ctx.answerCbQuery('âŒ Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø´Ù…Ø§ Ù†ÛŒØ³Øª.');
    }

    const price = calculateSellPrice(prod);

    const result = await changeCapital(userId, 'add', price);
    if (result !== 'ok') {
        return ctx.answerCbQuery('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø±Ù…Ø§ÛŒÙ‡.');
    }

    await prisma.productionLine.delete({ where: { id: prodId } });

    await ctx.reply(
        `âœ… "${prod.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ±ÙˆØ®ØªÙ‡ Ø´Ø¯.\n` +
        `ğŸ’° Ù…Ø¨Ù„Øº ${Math.floor(price / 1_000_000)}M Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`
    );

    ctx.answerCbQuery();
});

export default sell;



ghazie az in gharare ke
braye car bayad roozi 15 ta be user result bede
vali braye music o film o game bayad random 10-82% az mablaghi ke user be onvan sarmaye taiin karde be dailyprofitesh add beshe



in ham cron:
import cron from 'node-cron';
import { prisma } from './prisma';
import { Telegraf } from 'telegraf';
import config from './config/config.json';
import { runDailyTasks } from "./modules/helper/runDailyTasks";

const bot = new Telegraf(config.token);

// ğŸ“© Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function notifyUsersDaily() {
    const users = await prisma.user.findMany({ select: { userid: true } });

    for (const user of users) {
        try {
            await bot.telegram.sendMessage(
                user.userid.toString(),
                'ğŸ“… Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯ Ø¢ØºØ§Ø² Ø´Ø¯!\nâœ… Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯.\nğŸ”„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø³Ø§Ø®Øªâ€ŒÙˆØ³Ø§Ø² Ø±ÛŒØ³Øª Ø´Ø¯.'
            );
        } catch (err) {
            console.error(`âŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ${user.userid} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`);
        }
    }
}

// ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø¹Ù…ÙˆÙ…ÛŒ
async function notifyChannelDaily() {
    const channelId = config.channels.updates; // Ù…Ø«Ù„Ø§Ù‹ "@my_channel"
    try {
        await bot.telegram.sendMessage(channelId, 'ğŸ“¢ Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯ Ø¢ØºØ§Ø² Ø´Ø¯!');
    } catch (err) {
        console.error('âŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.');
    }
}

export async function deliverDailyCars() {
    const lines = await prisma.productionLine.findMany();
    const userStats: Record<string, { count: number; total: number }> = {};

    for (const line of lines) {
        const cars = Array.from({ length: line.dailyLimit }).map(() => {
            const price = Math.floor(Math.random() * (18_000_000 - 10_000_000 + 1)) + 10_000_000;
            const ownerId = line.ownerId.toString();

            if (!userStats[ownerId]) {
                userStats[ownerId] = { count: 0, total: 0 };
            }

            userStats[ownerId].count += 1;
            userStats[ownerId].total += price;

            return {
                ownerId: line.ownerId,
                name: line.name,
                imageUrl: line.imageUrl,
                price
            };
        });

        await prisma.car.createMany({ data: cars });
    }

    console.log(`âœ… ${lines.length} Ø®Ø· ØªÙˆÙ„ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯ Ùˆ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯.`);

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    for (const [userId, stats] of Object.entries(userStats)) {
        try {
            const message =
                `ğŸš— *ØªØ­ÙˆÛŒÙ„ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§*\n\n` +
                `ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ø®ÙˆØ¯Ø±Ùˆ: *${stats.count.toLocaleString()}*\n` +
                `ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø§Ø±Ø²Ø´: *${stats.total.toLocaleString()} Ø±ÛŒØ§Ù„*\n\n` +
                `ğŸ‰ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ Ø¨Ù‡ Ø§Ù†Ø¨Ø§Ø± Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù†Ø¯.`;

            await bot.telegram.sendMessage(userId, message, { parse_mode: 'Markdown' });
        } catch (err) {
            console.warn(`âŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ${userId} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`);
        }
    }
}

export async function deliverDailyProfit(bot: Telegraf) {
    const users = await prisma.user.findMany({ select: { userid: true, dailyProfit: true } });

    for (const user of users) {
        const profit = Number(user.dailyProfit || 0);
        if (profit <= 0) continue;

        await prisma.user.update({
            where: { userid: user.userid },
            data: {
                capital: { increment: profit }
            }
        });

        try {
            await bot.telegram.sendMessage(
                user.userid.toString(),
                `ğŸ’° *Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ ÙˆØ§Ø±ÛŒØ² Ø´Ø¯*\n\nâ• Ù…Ø¨Ù„Øº *${profit.toLocaleString()} Ø±ÛŒØ§Ù„* Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`,
                { parse_mode: 'Markdown' }
            );
        } catch (err) {
            console.warn(`âŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø³ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ${user.userid} Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`);
        }
    }

    console.log(`âœ… Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ ${users.length} Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±ÛŒØ² Ø´Ø¯.`);
}

// ğŸ•› Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ÙˆØ¸Ø§ÛŒÙ Ø±Ø£Ø³ Ø³Ø§Ø¹Øª Û°Û°:Û°Û°
cron.schedule('0 0 * * *', async () => {
    console.log('ğŸš€ Ø´Ø±ÙˆØ¹ ÙˆØ¸Ø§ÛŒÙ Ø±ÙˆØ²Ø§Ù†Ù‡...');
    await runDailyTasks(false);
    await deliverDailyCars();
    await deliverDailyProfit(bot);
    await notifyUsersDaily();
    await notifyChannelDaily();
    console.log('âœ… Ù‡Ù…Ù‡ ÙˆØ¸Ø§ÛŒÙ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù†Ø¯.');
});



bbin market faghat braye car productline hast
mikhaim ke aval az hame name ro az market be products taghir bedim chon gharare ke product haro manage konim

mikham ke product line ha ro be in sorat neshon bede (agar product line nadash be sorat inlinebtn mige nadare):
['name line']['price']['tedad tolidi dar rooz'][show]

3 btn aval az 4 btn namayeshi hastan vali show mire be panel marbot be product linesh mishe be in sorat:
['price per one']['price all']
[count one][count all]
['sell tab']
[sell count][sell all]
[close][back]

hamon tor ke malome 2 halat dare ke halat aval mishe mahsol to be tedad moshakhas forokht , va dovomi hame ro yekja mifroshi
price ha ham yekish gheimat yekdone hast o oon yeki gheimat hame ba ham

gheimat mashin ha ham har rooz tebgh cron bayad mojadad gheimat gozari beshe va random az 10-18M beshe ke braye har user ham mojazast