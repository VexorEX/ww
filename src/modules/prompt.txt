import { Composer, Markup } from 'telegraf';
import type { CustomContext } from '../middlewares/userAuth';
import { escapeMarkdownV2 } from '../utils/escape';
import { prisma } from '../prisma';
import config from '../config/config.json';
import { createProductionLine } from "./helper/Building";
import { changeCapital } from "./economy";
const admins: number[] = config.manage.buildings.admins;
const building = new Composer<CustomContext>();

// منوی اصلی ساخت‌وساز
building.action('building', async (ctx) => {
    const keyboard = Markup.inlineKeyboard([
        [Markup.button.callback('🚗 خودروسازی', 'build_car')],
        [Markup.button.callback('🎬 فیلم‌سازی', 'build_film')],
        [Markup.button.callback('🎵 موزیک‌سازی', 'build_music')],
        [Markup.button.callback('🎮 بازی‌سازی', 'build_game')],
        [Markup.button.callback('🔙 بازگشت', 'back_main'), Markup.button.callback('❌ بستن', 'delete')]
    ]);
    await ctx.reply('🏗 نوع ساخت‌وساز را انتخاب کن:', keyboard);
    ctx.answerCbQuery();
});


// شروع فرآیند ساخت خودرو
building.action('build_car', async (ctx) => {
    const userId = BigInt(ctx.from.id);
    const setupCost = 250_000_000;

    const user = await prisma.user.findUnique({ where: { userid: userId } });
    if (!user) return ctx.reply('❌ کاربر یافت نشد.');
    const pending = await prisma.pendingProductionLine.findMany({ where: { ownerId: userId } });

    if (pending) {
        const oneHourAgo = Date.now() - 60 * 60 * 1000;
        const requestTime = ctx.session.buildingRequestTime ?? 0;

        if (requestTime < oneHourAgo) {
            // برگرداندن سرمایه
            const refund = await changeCapital(userId, 'add', Number(pending.setupCost));
            if (refund === 'not_found') {
                await ctx.reply('❌ کاربر یافت نشد برای بازگشت سرمایه.');
            } else if (refund === 'invalid' || refund === 'error') {
                await ctx.reply('❌ خطا در بازگشت سرمایه.');
            } else {
                await ctx.reply(`⌛ درخواست قبلی منقضی شد و مبلغ ${Number(pending.setupCost / BigInt(1_000_000)).toLocaleString()}M به حساب شما برگشت.`);
            }

            await prisma.pendingProductionLine.deleteMany({ where: { ownerId: userId } });
            ctx.session.buildingUsedToday = false;
            ctx.session.lastBuildDate = undefined;
            ctx.session.buildingRequestTime = undefined;
            return;
        } else {
            return ctx.reply('⛔ هنوز درخواست قبلی در حال بررسیه. لطفاً صبر کن یا بعداً دوباره تلاش کن.');
        }
    }


    // بررسی محدودیت ساخت‌وساز روزانه
    ctx.session ??= {};
    if (ctx.session.buildingUsedToday) {
        return ctx.reply('⛔ شما امروز قبلاً ساخت‌وساز انجام داده‌اید. لطفاً فردا دوباره تلاش کنید.');
    }
    const today = new Date().toDateString();
    ctx.session ??= {};

    if (ctx.session.lastBuildDate === today) {
        return ctx.reply('⛔ شما امروز قبلاً ساخت‌وساز انجام داده‌اید. لطفاً فردا دوباره تلاش کنید.');
    }

    if (user.capital < setupCost) {
        return ctx.reply(`❌ بودجه کافی ندارید!\n💰 بودجه مورد نیاز: ${(setupCost / 1_000_000).toLocaleString()}M\n💳 بودجه فعلی شما: ${Number(user.capital / BigInt(1_000_000)).toLocaleString()}M`);
    }

    ctx.session ??= {};
    ctx.session.buildingType = 'car';
    ctx.session.buildingStep = 'awaiting_car_name';
    ctx.session.setupCost = setupCost;
    await ctx.reply('🚗 نام محصول خود را وارد کن:');
    ctx.answerCbQuery();
});
// دریافت نام خودرو
building.on('text', async (ctx, next) => {
    ctx.session ??= {};
    if (ctx.session.buildingStep === 'awaiting_car_name') {
        const name = ctx.message.text?.trim();
        if (!name || name.length < 2) {
            return ctx.reply('❌ نام محصول معتبر نیست. لطفاً دوباره وارد کن.');
        }

        ctx.session.carName = name;
        ctx.session.buildingStep = 'awaiting_car_image';
        await ctx.reply('🖼 حالا تصویر محصول را ارسال کن:');
    } else {
        return next();
    }

});
// دریافت تصویر خودرو و نمایش پیش‌نمایش
building.on('photo', async (ctx, next) => {
    ctx.session ??= {};
    if (ctx.session.buildingStep !== 'awaiting_car_image') return next();

    const photo = ctx.message.photo?.at(-1);
    if (!photo) return ctx.reply('❌ تصویر معتبر ارسال نشده.');

    const imageUrl = await ctx.telegram.getFileLink(photo.file_id);
    ctx.session.carImage = imageUrl.href;

    ctx.session.buildingStep = 'awaiting_build_description';
    await ctx.reply('📝 توضیحی درباره محصولت بنویس (مثلاً ویژگی‌ها یا هدف تولید):');

    ctx.session.carImageFileId = photo.file_id;

    ctx.session.buildingStep = 'awaiting_admin_review';
});
building.on('text', async (ctx, next) => {
    ctx.session ??= {};
    if (ctx.session.buildingStep === 'awaiting_build_description') {
        const description = ctx.message.text?.trim();
        if (!description || description.length < 5) {
            return ctx.reply('❌ توضیح خیلی کوتاهه. لطفاً بیشتر توضیح بده.');
        }

        ctx.session.buildingDescription = description;
        ctx.session.buildingStep = 'awaiting_admin_review';

        const preview = escapeMarkdownV2(
            `🏭 پیش‌نمایش خط تولید خودرو\n\n` +
            `> کشور سازنده: **${ctx.user?.countryName}**\n` +
            `> محصول: **${ctx.session.carName}**\n` +
            `> توضیح: ${ctx.session.buildingDescription}\n\n` +
            `بودجه راه‌اندازی: 250M\nظرفیت تولید روزانه: 15 خودرو\n\n` +
            `✅ اگر تأیید می‌کنی، دکمه زیر را بزن تا برای بررسی ادمین ارسال شود.`
        );

        const confirmKeyboard = Markup.inlineKeyboard([
            [Markup.button.callback('✅ ارسال برای تأیید ادمین', 'submit_building')],
            [Markup.button.callback('🔙 بازگشت', 'building')]
        ]);

        await ctx.replyWithPhoto(ctx.session.carImageFileId, {
            caption: preview,
            parse_mode: 'MarkdownV2',
            reply_markup: confirmKeyboard.reply_markup
        });
    } else {
        return next();
    }
});

// ارسال درخواست به ادمین
building.action('submit_building', async (ctx) => {
    ctx.session ??= {};
    ctx.session.buildingUsedToday = true;
    ctx.session.lastBuildDate = new Date().toDateString();
    ctx.session.buildingRequestTime = Date.now();

    const { carName, carImage, carImageFileId, setupCost } = ctx.session;
    const countryName = ctx.user?.countryName;
    const userId = BigInt(ctx.from.id);

    if (!carName || !carImage || !carImageFileId || !countryName || !setupCost) {
        return ctx.reply('❌ اطلاعات ناقص است.');
    }

    // کسر پول با استفاده از changeCapital
    const result = await changeCapital(userId, 'subtract', setupCost);
    if (result === 'not_found') {
        return ctx.reply('❌ کاربر یافت نشد.');
    }
    if (result === 'invalid' || result === 'error') {
        return ctx.reply('❌ خطا در کسر پول.');
    }

    await prisma.pendingProductionLine.upsert({
        where: { ownerId: userId },
        update: {
            name: carName,
            type: 'car',
            imageUrl: carImage,
            imageFileId: carImageFileId,
            dailyLimit: 15,
            setupCost: BigInt(setupCost),
            country: countryName
        },
        create: {
            ownerId: userId,
            name: carName,
            type: 'car',
            imageUrl: carImage,
            imageFileId: carImageFileId,
            dailyLimit: 15,
            setupCost: BigInt(setupCost),
            country: countryName
        }
    });


    if (['film', 'music', 'game'].includes(buildingType)) {
        const profitPercent = Math.floor(10 + Math.random() * 72);

        await prisma.pendingProductionLine.create({
            data: {
                ownerId: userId,
                name: buildingName,
                type: buildingType,
                imageFileId: buildingImageFileId,
                imageUrl,
                description: buildingDescription,
                setupCost: BigInt(setupCost),
                dailyLimit: 15,
                country,
                profitPercent
            }
        });

        // ارسال به ادمین‌ها
        for (const admin of admins) {
            await ctx.telegram.sendPhoto(admin, buildingImageFileId, {
                caption: escapeMarkdownV2(
                    `📥 درخواست ساخت پروژه ${buildingType}\n\n` +
                    `> کشور: **${country}**\n` +
                    `> نام: **${buildingName}**\n` +
                    `> توضیح: ${buildingDescription}\n` +
                    `> بودجه: ${Math.floor(setupCost / 1_000_000)}M\n` +
                    `> سوددهی: ${profitPercent}%`
                ),
                parse_mode: 'MarkdownV2',
                reply_markup: Markup.inlineKeyboard([
                    [Markup.button.callback('✅ تأیید ساخت', `admin_approve_building_${userId}`)],
                    [Markup.button.callback('❌ رد درخواست', `admin_reject_building_${userId}`)]
                ]).reply_markup
            });
        }

        await ctx.reply('📤 درخواست شما برای بررسی ادمین ارسال شد.');
        ctx.session.buildingStep = undefined;
    }


    const adminKeyboard = Markup.inlineKeyboard([
        [Markup.button.callback('✅ تأیید ساخت', `admin_approve_building_${userId}`)],
        [Markup.button.callback('❌ رد درخواست', `admin_reject_building_${userId}`)]
    ]);

    for (const admin of admins) {
        await ctx.telegram.sendPhoto(admin, carImageFileId, {
            caption: escapeMarkdownV2(
                `📥 درخواست ساخت خط تولید خودرو\n\n` +
                `> کشور: **${countryName}**\n` +
                `> محصول: **${carName}**\n` +
                `> توضیح: ${ctx.session.buildingDescription}\n\n` +
                `بودجه: 250M\nظرفیت تولید روزانه: 15 خودرو`
            ),
            parse_mode: 'MarkdownV2',
            reply_markup: adminKeyboard.reply_markup
        });
    }

    await ctx.reply('📤 درخواست شما برای بررسی ادمین ارسال شد.');
    ctx.session.buildingStep = undefined;
});
// تأیید نهایی توسط ادمین
building.action(/admin_approve_building_(\d+)/, async (ctx) => {
    const userId = BigInt(ctx.match[1]);

    const user = await prisma.user.findUnique({ where: { userid: userId } });
    if (!user) return ctx.reply('❌ کاربر یافت نشد.');

    const pending = await prisma.pendingProductionLine.findMany({ where: { ownerId: userId } });
    if (!pending) return ctx.reply('❌ اطلاعات محصول یافت نشد.');

    if (['film', 'music', 'game'].includes(pending.type)) {
        await prisma.productionLine.create({
            data: {
                ownerId: userId,
                name: pending.name,
                type: pending.type,
                imageUrl: pending.imageUrl,
                dailyLimit: pending.dailyLimit,
                setupCost: pending.setupCost,
                country: pending.country,
                profitPercent: pending.profitPercent
            }
        });

        await prisma.pendingProductionLine.delete({ where: { id: pending.id } });

        await ctx.telegram.sendPhoto(config.channels.updates, pending.imageFileId, {
            caption: escapeMarkdownV2(
                `🎬 پروژه جدید تأیید شد\n\n` +
                `> کشور: **${user.countryName}**\n` +
                `> نام: **${pending.name}**\n` +
                `> نوع: ${pending.type}`
            ),
            parse_mode: 'MarkdownV2'
        });

        await ctx.reply('✅ پروژه تأیید شد و به کانال ارسال شد.');
    }

    const result = await createProductionLine({
        ownerId: userId,
        country: pending.country,
        name: pending.name,
        type: pending.type,
        imageUrl: pending.imageUrl,
        dailyLimit: pending.dailyLimit,
        setupCost: pending.setupCost,
        carName: pending.name
    });

    if (result.error) return ctx.reply(result.error);

    await prisma.pendingProductionLine.deleteMany({ where: { ownerId: userId } });

    await ctx.telegram.sendPhoto(config.channels.updates, pending.imageFileId, {
        caption: escapeMarkdownV2(
            `🏭 خط تولید جدید راه‌اندازی شد\n\n` +
            `> کشور سازنده: **${user.countryName}**\n` +
            `> محصول: **${pending.name}**\n\n` +
            `بودجه راه‌اندازی: ${pending.setupCost.toLocaleString()} ریال\n` +
            `ظرفیت تولید روزانه: ${pending.dailyLimit} واحد`
        ),
        parse_mode: 'MarkdownV2'
    });

    await ctx.reply('✅ خط تولید ثبت شد و به کانال ارسال شد.');
});
// رد درخواست توسط ادمین
building.action(/admin_reject_building_(\d+)/, async (ctx) => {
    const userId = BigInt(ctx.match[1]);
    const adminId = ctx.from.id;

    if (!admins.includes(adminId)) {
        return ctx.answerCbQuery('⛔ فقط ادمین می‌تونه رد کنه.');
    }


    const pending = await prisma.pendingProductionLine.findMany({ where: { ownerId: userId } });
    if (!pending) {
        return ctx.answerCbQuery('❌ درخواست یافت نشد.');
    }

    // برگرداندن پول
    const result = await changeCapital(userId, 'add', Number(pending.setupCost));
    if (result === 'not_found') {
        return ctx.answerCbQuery('❌ کاربر یافت نشد.');
    }
    if (result === 'invalid' || result === 'error') {
        return ctx.answerCbQuery('❌ خطا در برگرداندن پول.');
    }

    // حذف درخواست
    await prisma.pendingProductionLine.deleteMany({ where: { ownerId: userId } });

    // اطلاع‌رسانی به کاربر
    try {
        await ctx.telegram.sendMessage(Number(userId),
            `❌ درخواست ساخت خط تولید شما رد شد.\n💰 مبلغ ${Number(pending.setupCost / BigInt(1_000_000)).toLocaleString()}M به حساب شما برگشت.`
        );
    } catch (err) {
        console.warn('ارسال پیام به PV کاربر ممکن نبود:', err);
    }

    await ctx.answerCbQuery('✅ درخواست رد شد و پول برگشت.');
});

for (const type of ['film', 'music', 'game']) {
    building.action(`build_${type}`, async (ctx) => {
        ctx.session = {
            buildingType: type,
            buildingStep: 'awaiting_name'
        };
        await ctx.reply(`📌 نام پروژه ${type === 'film' ? 'فیلم' : type === 'music' ? 'موزیک' : 'بازی'} را وارد کن:`);
        ctx.answerCbQuery();
    });
}



export default building;



in ham schema:
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client" // optional: client رو در src بساز برای import آسان
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  userid       BigInt @id
  country      String
  countryName  String // نام کشور + ایموجی
  level        Int    @default(0)
  rank         Int    @default(0)
  government   String
  religion     String @default("islam")
  crowd        BigInt @default(15000000)
  capital      BigInt @default(150000000)
  dailyProfit  BigInt @default(100000000)
  satisfaction Int    @default(80)
  security     Int    @default(80)
  lottery      Int    @default(0)

  // منابع
  oil         Int @default(0)
  iron        Int @default(0)
  gold        Int @default(0)
  uranium     Int @default(0)
  goldMine    Int @default(0)
  uraniumMine Int @default(0)
  ironMine    Int @default(0)
  refinery    Int @default(0)

  // ارتش پایه
  soldier   Int @default(0)
  tank      Int @default(0)
  heavyTank Int @default(0)

  // جنگنده‌ها
  su57 Int @default(0)
  f47  Int @default(0)
  f35  Int @default(0)
  j20  Int @default(0)
  f16  Int @default(0)
  f22  Int @default(0)
  am50 Int @default(0)
  b2   Int @default(0)
  tu16 Int @default(0)

  // پهپادها
  espionageDrone Int @default(0)
  suicideDrone   Int @default(0)
  crossDrone     Int @default(0)
  witnessDrone   Int @default(0)

  // موشک‌ها
  simpleRocket      Int @default(0)
  crossRocket       Int @default(0)
  dotTargetRocket   Int @default(0)
  continentalRocket Int @default(0)
  ballisticRocket   Int @default(0)
  chemicalRocket    Int @default(0)
  hyperSonicRocket  Int @default(0)
  clusterRocket     Int @default(0)

  // کشتی‌های دریایی
  battleship       Int @default(0)
  marineShip       Int @default(0)
  breakerShip      Int @default(0)
  nuclearSubmarine Int @default(0)

  // دفاع
  antiRocket Int @default(0)
  ironDome   Int @default(0)
  s400       Int @default(0)
  taad       Int @default(0)
  hq9        Int @default(0)
  acash      Int @default(0)

  @@map("users")
}

model ProductionLine {
  id            Int      @id @default(autoincrement())
  ownerId       BigInt
  country       String
  name          String
  type          String // مثل 'car', 'game', 'movie'
  imageUrl      String
  dailyLimit    Int
  setupCost     BigInt
  createdAt     DateTime @default(now())
  carName       String?
  unitPrice     Int? // فقط برای خودرو
  profitPercent Int? // فقط برای پروژه‌های عمرانی
}

model PendingProductionLine {
  id            Int      @id @default(autoincrement()) // ← اضافه کن
  ownerId       BigInt
  name          String
  type          String
  imageUrl      String
  imageFileId   String
  description   String
  dailyLimit    Int
  setupCost     BigInt
  country       String
  profitPercent Int?
  createdAt     DateTime @default(now()) // ← اضافه کن

  @@map("PendingProductionLine")
}

model Car {
  id        Int      @id @default(autoincrement())
  ownerId   BigInt
  name      String
  imageUrl  String
  price     Int
  createdAt DateTime @default(now())
}

model PendingBuilding {
  id        Int      @id @default(autoincrement())
  userId    BigInt
  carName   String
  imageUrl  String
  createdAt DateTime @default(now())
}




moshkel ine ke maghadir pening ro peida nmikone